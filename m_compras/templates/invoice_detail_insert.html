{% extends 'base.html' %}
{% block content %}
{% load static %}
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-qzQDbl2BMX68fiWlHqESgHnQUdyNaa9Uz44e5w70iJWILl3e9MCZkP1CSn8LkJB4sGjgGqkg8H6fs9lT2cpliQ==" crossorigin="anonymous" />
      <title>Tienda de Productos</title>
      <link rel="stylesheet" href="{% static 'css/deta.css' %}" />
      <!-- ... (otras etiquetas meta, title, etc.) ... -->
    <body>
      <div class="left-side">
        <div class="product-list">
          {% for product in products %}
            <div class="product-card">
              <div class="product-image">
                <img src="{{ product.pro_image_url }}" alt="{{ product.pro_name }}" loading="lazy" />
              </div>
              <div class="product-details">
                <h4>{{ product.pro_name }}</h4>
                <p class="description">Descripción: {{ product.pro_descripcion }}</p>
                <p class="price">Precio: ${{ product.pro_pvp }}</p>
                <p class="stock">Stock: {{ product.pro_stock }}</p>
                <p class="iva">Iva: {{ product.pro_iva }}</p>
                <div class="quantity-input">
                  <label for="quantity{{ product.pro_id }}">Cantidad:</label>
                  <input type="number" id="quantity{{ product.pro_id }}" name="quantity{{ product.pro_id }}" value="1" min="1" />
                </div>
                <button class="add-to-cart" onclick="addProductToInvoiceDetail(
            '{{ product.pro_id }}',
            '{{ product.pro_name }}',
            '{{ product.pro_pvp }}',
            '{{ product.pro_stock }}',
            '{{ product.pro_iva|lower }}')">Agregar al Carrito</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="right-side">
        <h2>Productos Agregados</h2>
        <form method="post" action="{% if invo_det_invo_id %}{% url 'invoice_detail_insert' invo_det_invo_id %}{% endif %}">
          {% csrf_token %}
          <!-- Contenido de la derecha -->
          <table border="1">
            <thead>
              <tr>
                <th>Accion</th>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody id="invoice_detail_table"></tbody>
          </table>
          <!-- Mostrar errores si existen -->
          {% if error %}
            <div>{{ error }}</div>
          {% endif %}
          <!-- Botón para registrar productos -->
          <button id="subir" type="button" onclick="registerProducts()">Registrar Productos</button>
          <button id="imprimir" type="button" onclick="generarPDF()">
            <i class="fas fa-file-pdf"></i> Generar PDF
          </button>
        </form>
      </div>

      <script src="https://code.jquery.com/jquery-3.6.4.min.js" async></script>
      <script>
        // Variable global para almacenar los productos
        let products_data = [];

// Función para agregar o actualizar un producto en la tabla de la derecha
function addProductToInvoiceDetail(productId, productName, productPrice, productStock, productIva) {
    var quantity = $('#quantity' + productId).val();
    var subtotal = parseFloat(productPrice) * parseInt(quantity);

    // Buscar si el producto ya existe en el array
    var existingProduct = products_data.find(p => p.prod_id === productId);

    if (existingProduct) {
        // Actualizar la cantidad y subtotal del producto existente
        existingProduct.prod_quantity = parseInt(existingProduct.prod_quantity) + parseInt(quantity);
        existingProduct.prod_subtotal += subtotal;
    } else {
        // Crear un nuevo objeto producto y agregarlo al array
        var newProduct = {
            prod_id: productId,
            prod_name: productName,
            prod_price: productPrice,
            prod_quantity: quantity,
            prod_subtotal: subtotal
        };
        products_data.push(newProduct);
    }

    // Actualizar la tabla
    updateInvoiceDetailTable();
}

// Función para actualizar la tabla de detalles de la factura
function updateInvoiceDetailTable() {
    var tableBody = $('#invoice_detail_table');
    tableBody.empty(); // Limpiar la tabla antes de agregar nuevas filas

    // Agregar cada producto al DOM de la tabla
    products_data.forEach(product => {
        var newRow = `<tr>
            <td><button id="quitar" type="button" onclick="removeProduct('${product.prod_id}')">Eliminar</button></td>
            <td>${product.prod_name}</td>
            <td>${product.prod_price}</td>
            <td>${product.prod_quantity}</td>
            <td>${product.prod_subtotal}</td>
        </tr>`;
        tableBody.append(newRow);
    });
}
          // Nueva función para eliminar un producto de la tabla
        function removeProduct(productId) {
          // Filtrar el array de productos para excluir el producto con el ID proporcionado
          products_data = products_data.filter(product => product.prod_id !== productId);
          // Actualizar la tabla después de eliminar el producto
          updateInvoiceDetailTable();
        }
        function registerProducts() {
            // Verificar si hay productos para registrar
            if (products_data.length === 0) {
                alert('No hay productos para registrar.');
                return;
            }

            // Obtener el token CSRF del documento
            var csrfToken = $('input[name=csrfmiddlewaretoken]').val()

            // Obtener el invo_det_invo_id de la URL actual
            var invo_det_invo_id = window.location.pathname.split('/').slice(-2, -1)[0]

            console.log('products_data =', products_data)

            let products_json = JSON.stringify(products_data)

            console.log('products_json =', products_json)

            // Enviar los datos al servidor mediante una petición AJAX
            $.ajax({
                type: 'POST',
                url: '/m_compras/invoice_detail_insert/' + invo_det_invo_id + '/',
                data: JSON.stringify({ "products": products_data }),
                contentType: 'application/json; charset=utf-8',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                success: function (response) {
                    // Manejar la respuesta del servidor si es necesario
                    alert('Productos registrados con éxito');

                    // Redirigir a la página de consultar_facturas
                    window.location.href = '/m_compras/consultar_facturas/';
                },
                dataType: 'json',
                error: function (error) {
                    console.error('Error al registrar productos:', error)
                    alert('Error al registrar productos. Detalles en la consola.')
                }
            });

            // Limpiar el array después de enviar los datos
            products_data = [];
        }
        
      </script>


      
    </body>
{% endblock %}
